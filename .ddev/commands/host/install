#!/bin/bash

## Description: Install TYPO3 if not already installed
## Usage: install
## Example: ddev install

set -e

MARKER_FILE=".ddev/.installed"

check_typo3_installed() {
    local table_count
    table_count=$(ddev mysql -N -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'db';" 2>/dev/null || echo "0")
    if [ "$table_count" -gt 0 ] && [ -f "$MARKER_FILE" ]; then
        return 0
    fi
    return 1
}

if check_typo3_installed; then
    echo "TYPO3 is already installed. Skipping setup."
    exit 0
fi

echo "=========================================="
echo "Installing TYPO3 14 with sluggi extension"
echo "=========================================="

echo "Installing composer dependencies..."
if [ ! -f "composer.lock" ]; then
    ddev composer update --no-interaction
else
    ddev composer install --no-interaction
fi

echo "Dropping existing database tables (fresh install)..."
ddev mysql -e "DROP DATABASE IF EXISTS db; CREATE DATABASE db;"

echo "Removing old secrets (will be regenerated)..."
rm -f var/.secrets.php

echo "Setting up TYPO3..."
ddev exec ./vendor/bin/typo3 setup \
    --driver=mysqli \
    --host=db \
    --port=3306 \
    --dbname=db \
    --username=db \
    --password=db \
    --admin-username=docker \
    --admin-user-password='Docker.1!' \
    --admin-email=admin@example.com \
    --project-name="sluggi Demo" \
    --create-site="https://sluggi-typo3-14.ddev.site/" \
    --server-type=other \
    --no-interaction \
    --force

echo "Setting simple admin password for demo..."
ddev mysql -e "DELETE FROM be_users WHERE username = 'docker';"
ddev mysql -e "INSERT INTO be_users (uid, pid, tstamp, crdate, deleted, disable, starttime, endtime, username, password, admin) VALUES (1, 0, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), 0, 0, 0, 0, 'docker', '\$argon2i\$v=19\$m=65536,t=16,p=1\$M2s3SFlCQkZZNXhjOVFNUg\$+JVwo7NkqRqxQz7RhyvyE13SLth4mFaBrQdLNIGDQDo', 1);"

echo "Building frontend assets..."
ddev exec 'npm ci && npm run build'

echo "Flushing caches..."
ddev exec ./vendor/bin/typo3 cache:flush

touch "$MARKER_FILE"

echo "Enabling Playwright (will rebuild container with browser dependencies)..."
ddev install-playwright

echo ""
echo "=========================================="
echo "TYPO3 installation complete!"
echo ""
echo "Backend:  https://sluggi-typo3-14.ddev.site/typo3"
echo "Login:    docker / docker"
echo ""
echo "Run E2E tests: ddev e2e"
echo "=========================================="
