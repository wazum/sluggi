{"version":3,"file":"redirect-notification-handler.js","sources":["../../../src/redirect-notification-handler.ts"],"sourcesContent":["import AjaxRequest from '@typo3/core/ajax/ajax-request.js';\nimport Notification from '@typo3/backend/notification.js';\nimport DeferredAction from '@typo3/backend/action-button/deferred-action.js';\n\nconst STORAGE_KEY = 'sluggi-redirect-choice';\n\ninterface RedirectChoice {\n    pageId: string;\n    createRedirects: boolean;\n    timestamp: number;\n}\n\ninterface SlugChangedCorrelations {\n    correlationIdSlugUpdate: string;\n    correlationIdRedirectCreation: string;\n}\n\ninterface SlugChangedEventDetail {\n    autoCreateRedirects?: boolean;\n    autoUpdateSlugs?: boolean;\n    correlations?: SlugChangedCorrelations;\n}\n\ninterface RevertResponse {\n    status: 'ok' | 'error';\n    title: string;\n    message: string;\n}\n\nclass RedirectNotificationHandler {\n    constructor() {\n        document.addEventListener('typo3:redirects:slugChanged', (event) => this.onSlugChanged(event as CustomEvent<SlugChangedEventDetail>), true);\n    }\n\n    static storeChoice(pageId: string, createRedirects: boolean): void {\n        localStorage.setItem(STORAGE_KEY, JSON.stringify({ pageId, createRedirects, timestamp: Date.now() }));\n    }\n\n    static getAndClearChoice(): RedirectChoice | null {\n        const stored = localStorage.getItem(STORAGE_KEY);\n        if (!stored) return null;\n\n        localStorage.removeItem(STORAGE_KEY);\n\n        try {\n            const data = JSON.parse(stored) as RedirectChoice;\n            if (Date.now() - data.timestamp > 30000) return null;\n            return data;\n        } catch {\n            return null;\n        }\n    }\n\n    private static derivePageUpdateCorrelationId(correlationIdSlugUpdate: string): string {\n        const slashIndex = correlationIdSlugUpdate.indexOf('/');\n        return slashIndex === -1 ? correlationIdSlugUpdate : correlationIdSlugUpdate.substring(0, slashIndex);\n    }\n\n    onSlugChanged(event: CustomEvent<SlugChangedEventDetail>): void {\n        const choice = RedirectNotificationHandler.getAndClearChoice();\n        if (choice && !choice.createRedirects && event.detail?.autoCreateRedirects) {\n            event.detail.autoCreateRedirects = false;\n        }\n\n        const detail = event.detail;\n        if (!detail?.correlations) return;\n\n        event.stopImmediatePropagation();\n\n        const correlations = detail.correlations;\n        const correlationIdPageUpdate = RedirectNotificationHandler.derivePageUpdateCorrelationId(correlations.correlationIdSlugUpdate);\n        const actions: Array<{ label: string; action: DeferredAction }> = [];\n\n        if (detail.autoUpdateSlugs) {\n            actions.push({\n                label: TYPO3.lang['notification.redirects.button.revert_update'],\n                action: new DeferredAction(async () => {\n                    await this.revert([\n                        correlationIdPageUpdate,\n                        correlations.correlationIdSlugUpdate,\n                        correlations.correlationIdRedirectCreation,\n                    ], true);\n                }),\n            });\n        }\n\n        if (detail.autoCreateRedirects) {\n            actions.push({\n                label: TYPO3.lang['notification.redirects.button.revert_redirect'],\n                action: new DeferredAction(async () => {\n                    await this.revert([correlations.correlationIdRedirectCreation], false);\n                }),\n            });\n        }\n\n        let title = TYPO3.lang['notification.slug_only.title'];\n        let message = TYPO3.lang['notification.slug_only.message'];\n\n        if (detail.autoCreateRedirects) {\n            title = TYPO3.lang['notification.slug_and_redirects.title'];\n            message = TYPO3.lang['notification.slug_and_redirects.message'];\n        }\n\n        Notification.info(title, message, 0, actions);\n    }\n\n    private async revert(correlationIds: string[], reloadPage: boolean): Promise<void> {\n        let success = false;\n        try {\n            const response = await new AjaxRequest(TYPO3.settings.ajaxUrls.redirects_revert_correlation)\n                .withQueryArguments({ correlation_ids: correlationIds })\n                .get();\n            const result = await response.resolve() as RevertResponse;\n            if (result.status === 'ok') {\n                Notification.success(result.title, result.message);\n                success = true;\n            } else {\n                Notification.error(result.title, result.message);\n            }\n        } catch {\n            Notification.error(\n                TYPO3.lang.redirects_error_title,\n                TYPO3.lang.redirects_error_message,\n            );\n        }\n        document.dispatchEvent(new CustomEvent('typo3:pagetree:refresh'));\n        if (reloadPage && success) {\n            window.location.reload();\n        }\n    }\n}\n\nexport { RedirectNotificationHandler };\nexport default new RedirectNotificationHandler();\n"],"names":["STORAGE_KEY","RedirectNotificationHandler","event","pageId","createRedirects","stored","data","correlationIdSlugUpdate","slashIndex","choice","detail","correlations","correlationIdPageUpdate","actions","DeferredAction","title","message","Notification","correlationIds","reloadPage","success","result","AjaxRequest","redirectNotificationHandler"],"mappings":"6JAIA,MAAMA,EAAc,yBAyBpB,MAAMC,CAA4B,CAC9B,aAAc,CACV,SAAS,iBAAiB,8BAAgCC,GAAU,KAAK,cAAcA,CAA4C,EAAG,EAAI,CAC9I,CAEA,OAAO,YAAYC,EAAgBC,EAAgC,CAC/D,aAAa,QAAQJ,EAAa,KAAK,UAAU,CAAE,OAAAG,EAAQ,gBAAAC,EAAiB,UAAW,KAAK,IAAA,CAAI,CAAG,CAAC,CACxG,CAEA,OAAO,mBAA2C,CAC9C,MAAMC,EAAS,aAAa,QAAQL,CAAW,EAC/C,GAAI,CAACK,EAAQ,OAAO,KAEpB,aAAa,WAAWL,CAAW,EAEnC,GAAI,CACA,MAAMM,EAAO,KAAK,MAAMD,CAAM,EAC9B,OAAI,KAAK,IAAA,EAAQC,EAAK,UAAY,IAAc,KACzCA,CACX,MAAQ,CACJ,OAAO,IACX,CACJ,CAEA,OAAe,8BAA8BC,EAAyC,CAClF,MAAMC,EAAaD,EAAwB,QAAQ,GAAG,EACtD,OAAOC,IAAe,GAAKD,EAA0BA,EAAwB,UAAU,EAAGC,CAAU,CACxG,CAEA,cAAcN,EAAkD,CAC5D,MAAMO,EAASR,EAA4B,kBAAA,EACvCQ,GAAU,CAACA,EAAO,iBAAmBP,EAAM,QAAQ,sBACnDA,EAAM,OAAO,oBAAsB,IAGvC,MAAMQ,EAASR,EAAM,OACrB,GAAI,CAACQ,GAAQ,aAAc,OAE3BR,EAAM,yBAAA,EAEN,MAAMS,EAAeD,EAAO,aACtBE,EAA0BX,EAA4B,8BAA8BU,EAAa,uBAAuB,EACxHE,EAA4D,CAAA,EAE9DH,EAAO,iBACPG,EAAQ,KAAK,CACT,MAAO,MAAM,KAAK,6CAA6C,EAC/D,OAAQ,IAAIC,EAAe,SAAY,CACnC,MAAM,KAAK,OAAO,CACdF,EACAD,EAAa,wBACbA,EAAa,6BAAA,EACd,EAAI,CACX,CAAC,CAAA,CACJ,EAGDD,EAAO,qBACPG,EAAQ,KAAK,CACT,MAAO,MAAM,KAAK,+CAA+C,EACjE,OAAQ,IAAIC,EAAe,SAAY,CACnC,MAAM,KAAK,OAAO,CAACH,EAAa,6BAA6B,EAAG,EAAK,CACzE,CAAC,CAAA,CACJ,EAGL,IAAII,EAAQ,MAAM,KAAK,8BAA8B,EACjDC,EAAU,MAAM,KAAK,gCAAgC,EAErDN,EAAO,sBACPK,EAAQ,MAAM,KAAK,uCAAuC,EAC1DC,EAAU,MAAM,KAAK,yCAAyC,GAGlEC,EAAa,KAAKF,EAAOC,EAAS,EAAGH,CAAO,CAChD,CAEA,MAAc,OAAOK,EAA0BC,EAAoC,CAC/E,IAAIC,EAAU,GACd,GAAI,CAIA,MAAMC,EAAS,MAHE,MAAM,IAAIC,EAAY,MAAM,SAAS,SAAS,4BAA4B,EACtF,mBAAmB,CAAE,gBAAiBJ,CAAA,CAAgB,EACtD,IAAA,GACyB,QAAA,EAC1BG,EAAO,SAAW,MAClBJ,EAAa,QAAQI,EAAO,MAAOA,EAAO,OAAO,EACjDD,EAAU,IAEVH,EAAa,MAAMI,EAAO,MAAOA,EAAO,OAAO,CAEvD,MAAQ,CACJJ,EAAa,MACT,MAAM,KAAK,sBACX,MAAM,KAAK,uBAAA,CAEnB,CACA,SAAS,cAAc,IAAI,YAAY,wBAAwB,CAAC,EAC5DE,GAAcC,GACd,OAAO,SAAS,OAAA,CAExB,CACJ,CAGA,MAAAG,EAAe,IAAItB"}