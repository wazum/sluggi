import g from"@typo3/core/ajax/ajax-request.js";import o from"@typo3/backend/notification.js";import u from"@typo3/backend/action-button/deferred-action.js";const c="sluggi-redirect-choice";class s{constructor(){document.addEventListener("typo3:redirects:slugChanged",e=>this.onSlugChanged(e),!0)}static storeChoice(e,t){localStorage.setItem(c,JSON.stringify({pageId:e,createRedirects:t,timestamp:Date.now()}))}static getAndClearChoice(){const e=localStorage.getItem(c);if(!e)return null;localStorage.removeItem(c);try{const t=JSON.parse(e);return Date.now()-t.timestamp>3e4?null:t}catch{return null}}static derivePageUpdateCorrelationId(e){const t=e.indexOf("/");return t===-1?e:e.substring(0,t)}onSlugChanged(e){const t=s.getAndClearChoice();t&&!t.createRedirects&&e.detail?.autoCreateRedirects&&(e.detail.autoCreateRedirects=!1);const r=e.detail;if(!r?.correlations)return;e.stopImmediatePropagation();const i=r.correlations,a=s.derivePageUpdateCorrelationId(i.correlationIdSlugUpdate),n=[];r.autoUpdateSlugs&&n.push({label:TYPO3.lang["notification.redirects.button.revert_update"],action:new u(async()=>{await this.revert([a,i.correlationIdSlugUpdate,i.correlationIdRedirectCreation],!0)})}),r.autoCreateRedirects&&n.push({label:TYPO3.lang["notification.redirects.button.revert_redirect"],action:new u(async()=>{await this.revert([i.correlationIdRedirectCreation],!1)})});let l=TYPO3.lang["notification.slug_only.title"],d=TYPO3.lang["notification.slug_only.message"];r.autoCreateRedirects&&(l=TYPO3.lang["notification.slug_and_redirects.title"],d=TYPO3.lang["notification.slug_and_redirects.message"]),o.info(l,d,0,n)}async revert(e,t){let r=!1;try{const a=await(await new g(TYPO3.settings.ajaxUrls.redirects_revert_correlation).withQueryArguments({correlation_ids:e}).get()).resolve();a.status==="ok"?(o.success(a.title,a.message),r=!0):o.error(a.title,a.message)}catch{o.error(TYPO3.lang.redirects_error_title,TYPO3.lang.redirects_error_message)}document.dispatchEvent(new CustomEvent("typo3:pagetree:refresh")),t&&r&&window.location.reload()}}const h=new s;export{s as RedirectNotificationHandler,h as default};
//# sourceMappingURL=redirect-notification-handler.js.map
