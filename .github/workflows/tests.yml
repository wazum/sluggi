name: Tests

on:
  push:
    branches:
      - 'demo-*'
  pull_request:

jobs:
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: intl
          tools: composer

      - name: Install dependencies
        run: composer install --no-interaction

      - name: Run PHPStan
        run: composer phpstan

      - name: Run PHP CS Fixer
        run: composer cs:check

  js-unit:
    name: JavaScript Unit Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run TypeScript check
        run: npm run typecheck

      - name: Run unit tests
        run: npm run test

  unit:
    name: Unit (PHP ${{ matrix.php }} - TYPO3 ${{ matrix.typo3 }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # TYPO3 12.4 LTS
          - php: '8.2'
            typo3: '12.4'
          - php: '8.3'
            typo3: '12.4'
          # TYPO3 13.4 LTS
          - php: '8.2'
            typo3: '13.4'
          - php: '8.3'
            typo3: '13.4'
          - php: '8.4'
            typo3: '13.4'
          # TYPO3 14.x
          - php: '8.2'
            typo3: '14.0'
          - php: '8.3'
            typo3: '14.0'
          - php: '8.4'
            typo3: '14.0'

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: intl
          tools: composer

      - name: Install dependencies
        run: |
          composer require "typo3/cms-core:^${{ matrix.typo3 }}" "typo3/cms-backend:^${{ matrix.typo3 }}" "typo3/cms-redirects:^${{ matrix.typo3 }}" --no-update --no-interaction
          composer install --no-interaction

      - name: Run unit tests
        run: vendor/bin/phpunit -c Tests/phpunit.xml --testsuite unit

  functional:
    name: Functional (PHP ${{ matrix.php }} - TYPO3 ${{ matrix.typo3 }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # TYPO3 12.4 LTS
          - php: '8.2'
            typo3: '12.4'
          - php: '8.3'
            typo3: '12.4'
          # TYPO3 13.4 LTS
          - php: '8.2'
            typo3: '13.4'
          - php: '8.3'
            typo3: '13.4'
          - php: '8.4'
            typo3: '13.4'
          # TYPO3 14.x
          - php: '8.2'
            typo3: '14.0'
          - php: '8.3'
            typo3: '14.0'
          - php: '8.4'
            typo3: '14.0'

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: intl, pdo_sqlite
          tools: composer

      - name: Install dependencies
        run: |
          composer require "typo3/cms-core:^${{ matrix.typo3 }}" "typo3/cms-backend:^${{ matrix.typo3 }}" "typo3/cms-redirects:^${{ matrix.typo3 }}" --no-update --no-interaction
          composer install --no-interaction

      - name: Run functional tests
        run: typo3DatabaseDriver=pdo_sqlite vendor/bin/phpunit --bootstrap vendor/typo3/testing-framework/Resources/Core/Build/FunctionalTestsBootstrap.php Tests/Functional

  e2e:
    name: E2E (PHP ${{ matrix.php }} - TYPO3 ${{ matrix.typo3 }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          # TYPO3 12.4 LTS
          - php: '8.2'
            typo3: '12.4'
          - php: '8.3'
            typo3: '12.4'
          # TYPO3 13.4 LTS
          - php: '8.2'
            typo3: '13.4'
          - php: '8.3'
            typo3: '13.4'
          - php: '8.4'
            typo3: '13.4'
          # TYPO3 14.x
          - php: '8.2'
            typo3: '14.0'
          - php: '8.3'
            typo3: '14.0'
          - php: '8.4'
            typo3: '14.0'

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: typo3
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: intl, pdo_mysql, gd, zip
          tools: composer

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create TYPO3 project
        run: composer create-project typo3/cms-base-distribution:^${{ matrix.typo3 }} typo3-test --no-interaction

      - name: Install sluggi extension
        run: |
          cd typo3-test
          composer config --unset platform.php
          composer config repositories.sluggi path ../
          composer require wazum/sluggi:@dev --no-interaction

      - name: Setup TYPO3
        run: |
          cd typo3-test
          ./vendor/bin/typo3 setup --driver=mysqli --host=127.0.0.1 --port=3306 \
            --dbname=typo3 --username=root --password=root \
            --admin-username=admin --admin-user-password=Password123! \
            --admin-email=admin@example.com --project-name=test \
            --server-type=other --no-interaction

      - name: Create site configuration
        run: |
          mkdir -p typo3-test/config/sites/main
          printf '%s\n' \
            "rootPageId: 1" \
            "base: 'http://127.0.0.1:8080/'" \
            "languages:" \
            "  - title: English" \
            "    enabled: true" \
            "    languageId: 0" \
            "    base: /" \
            "    locale: en_US.UTF-8" \
            "    navigationTitle: ''" \
            "    flag: us" \
            > typo3-test/config/sites/main/config.yaml

      - name: Import test fixtures
        run: mysql -h 127.0.0.1 -u root -proot typo3 < Tests/E2e/fixtures/database.sql

      - name: Configure extension settings
        run: |
          mkdir -p typo3-test/config/system
          cat > typo3-test/config/system/additional.php << 'EOF'
          <?php
          declare(strict_types=1);
          $GLOBALS['TYPO3_CONF_VARS']['BE']['passwordPolicy'] = '';
          $testId = $_SERVER['HTTP_X_PLAYWRIGHT_TEST_ID'] ?? 'default';
          $sluggiSettings = match ($testId) {
              'last-segment-only' => [
                  'exclude_doktypes' => '254',
                  'last_segment_only' => '1',
                  'synchronize' => '1',
                  'lock' => '0',
                  'allow_full_path_editing' => '1',
              ],
              'hierarchy-permission', 'field-access-restriction' => [
                  'exclude_doktypes' => '254',
                  'last_segment_only' => '0',
                  'synchronize' => '1',
                  'lock' => '1',
              ],
              'slug-lock' => [
                  'exclude_doktypes' => '254',
                  'last_segment_only' => '0',
                  'synchronize' => '1',
                  'lock' => '1',
              ],
              default => [
                  'exclude_doktypes' => '254',
                  'last_segment_only' => '0',
                  'synchronize' => '1',
                  'lock' => '1',
              ],
          };
          $GLOBALS['TYPO3_CONF_VARS']['EXTENSIONS']['sluggi'] = $sluggiSettings;
          EOF

      - name: Start PHP server
        run: |
          cd typo3-test/public
          php -S 127.0.0.1:8080 &
          sleep 5

      - name: Install Playwright
        run: |
          cd Tests/E2e
          npm ci
          npx playwright install --with-deps chromium

      - name: Run E2E tests
        run: |
          cd Tests/E2e
          mkdir -p .auth
          npm test
        env:
          TYPO3_BASE_URL: http://127.0.0.1:8080
          TYPO3_ADMIN_USER: admin
          TYPO3_ADMIN_PASS: docker

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results-php${{ matrix.php }}-typo3-${{ matrix.typo3 }}
          path: Tests/E2e/test-results/
          retention-days: 7
